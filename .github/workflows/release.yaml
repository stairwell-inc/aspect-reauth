name: Release

on:
  push:
    tags: ["v*"]
  workflow_dispatch:

jobs:
  build:
    uses: ./.github/workflows/build.yaml

  macos-release:
    name: macOS Release
    needs: build
    runs-on: [self-hosted, macOS]
    environment: macos
    steps:
    - uses: stairwell-inc/download-artifact@v4
      with:
        pattern: aspect-reauth-*-apple-darwin
    - run: |
        lipo -create -output aspect-reauth-universal aspect-reauth-{x86_64,aarch64}-apple-darwin/aspect-reauth
    - run: rm -rf aspect-reauth-*-apple-darwin

    - run: |
        set -e
        cp aspect-reauth-universal .tmp.$$
        trap "rm -f .tmp.$$" EXIT
        codesign -s 'Developer ID Application: Stairwell, Inc. (677UQVFGY8)' -f --timestamp -o runtime .tmp.$$
        mv .tmp.$$ aspect-reauth-signed

    - env:
        NOTARY_PASS: ${{ secrets.NOTARY_PASS }}
        DEV_ACCOUNT: ${{ secrets.DEV_ACCOUNT }}
      run: |
        set -e
        xcrun notarytool store-credentials --apple-id "$DEV_ACCOUNT" --team-id 677UQVFGY8 --password "$NOTARY_PASS" notary-aspect-reauth
        zip -qr aspect-reauth-notary-bundle.zip aspect-reauth-signed
        xcrun notarytool submit aspect-reauth-notary-bundle.zip --keychain-profile notary-aspect-reauth --wait

    - uses: stairwell-inc/upload-artifact@v4
      with:
        name: aspect-reauth-darwin
        path: aspect-reauth-signed
        if-no-files-found: error
